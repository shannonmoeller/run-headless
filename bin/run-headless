#!/usr/bin/env node

const minimist = require('minimist');
const run = require('..');

const args = minimist(process.argv.slice(2));
const usage = `
Usage: run-headless [options]

Options:

      --html <s>      Literal HTML to execute. Defaults to minimal skeleton.
      --js <s>        Literal JavaScript to execute (default: stdin).
      --url <s>       URL to load (overrides --html).
      --close <s>     Close global function (default: \`__close__\`).
      --coverage <s>  Coverage global variable (default: \`__coverage__\`).
      --output <s>    Coverage output file (default: \`.nyc_output/<rand>.json\`).
  -h, --help          Print help.

Examples:

  $ echo "console.log('hello world')" | run-headless
  $ run-headless --js "console.log('hello world')"
  $ run-headless --html "$(cat index.html)" --js "$(cat index.js)"
  $ run-headless --url "https://google.com" --js "console.log(document.title)"
`;

function main() {
	if (args.h || args.help) {
		console.log(usage);

		return;
	}

	if (process.stdin.isTTY) {
		run(args);

		return;
	}

	let js = '';

	process.stdin.on('data', chunk => {
		js += chunk;
	});

	process.stdin.on('end', () => {
		run(Object.assign({js}, args));
	});
}

process.on('unhandledRejection', err => {
	throw err;
});

main();
